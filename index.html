<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#2b6bff" />
  <link rel="manifest" href="manifest.webmanifest" />
  <title>Sudoku ‚Äì mobil</title>
  <style>
    /* ===== Bas & teman ===== */
    :root{ --shadow:0 8px 24px rgba(11,20,43,.08); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Noto Sans,sans-serif;background:var(--bg);color:var(--text);display:block;min-height:100svh;overflow-y:auto}
    body.theme-light{
      --bg:#f5f7fb; --card:#ffffff; --accent:#2b6bff;
      --prefill:#111; --prefill-bg:transparent; --main:#1f5eff; --note1:#ff0000; --note2:#2fa568;
      --hl-selected:#e8f0ff; --hl-same:#f3f7ff; --hl-same-rc:#eef4ff; --hl-note1-match:#fde9e9; --hl-note2-match:#e9f6ef;
      --error:#d12f2f; --muted:#445066; --text:#121417; --border:#d8deea
    }
    body.theme-dark{
      --bg:#0c0f14; --card:#151a22; --accent:#2b6bff;
      --prefill:#f1f5f9; --prefill-bg:#0f1626; --main:#cbe0ff; --note1:#ff6b6b; --note2:#60d394;
      --hl-selected:#14223d; --hl-same:#1a2744; --hl-same-rc:#141e33; --hl-note1-match:#2a1313; --hl-note2-match:#102a18;
      --error:#ff6b6b; --muted:#8ca0bf; --text:#f4f7fb; --border:#202a3a
    }

    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .screen{display:none}
    .screen.active{display:block}

    h1{margin:0 0 10px 0;font-size:34px;letter-spacing:.3px}
    h1 small{font-weight:600;opacity:.75;margin-left:.5ch}
    h2{margin:0 0 8px 0}
    .card{background:var(--card);padding:12px;border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);margin:10px 0}

    .grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:560px){.grid4{grid-template-columns:repeat(2,1fr)}}
    .col{display:flex;flex-direction:column;gap:8px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    .btn{appearance:none;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:16px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}
    .btn.icon{display:grid;place-items:center;padding:8px 12px}

    .slot{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px}
    .slot .meta{font-size:12px;color:var(--muted)}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .stats-grid .stat{padding:10px;border:1px solid var(--border);border-radius:12px;text-align:center;background:var(--card)}
    .stats-grid .stat strong{display:block;font-size:20px}

    /* ===== SPEL ===== */
    header.game{display:grid;grid-template-columns:1fr auto;grid-template-rows:auto auto;grid-template-areas:'title actions' 'stats actions';gap:8px;align-items:center;width:100%}
    .top-left{grid-area:title;display:flex;gap:8px;align-items:baseline;flex-wrap:wrap}
    .stats{grid-area:stats;display:flex;gap:16px;font-size:14px;color:var(--muted);flex-wrap:wrap}
    .stats > div{min-width:92px}
    .top-right{grid-area:actions;display:flex;gap:8px;flex-wrap:wrap;justify-self:end}

    .board-wrap{width:min(calc(100vw - 24px - env(safe-area-inset-left) - env(safe-area-inset-right)), 520px);margin:0 auto;}
    .board{position:relative;display:grid;grid-template-columns:repeat(9,1fr);aspect-ratio:1/1;background:var(--card);border-radius:16px;overflow:hidden;border:2px solid var(--grid);box-shadow:var(--shadow)}
    .cell{position:relative;border:1px solid var(--grid);display:grid;place-items:center;font-size:20px;font-weight:820;line-height:1;letter-spacing:.2px;font-variant-numeric:tabular-nums;user-select:none}
    .cell input{width:100%;height:100%;text-align:center;background:transparent;border:0;outline:0;font:inherit;color:var(--main);font-weight:inherit;pointer-events:none;caret-color:transparent}
    .cell.readonly input{color:var(--prefill)}
    .cell.readonly{background:var(--prefill-bg)}
    /* 3x3 block tjockare linjer */
    .cell[data-r="3"], .cell[data-r="6"]{ border-bottom:2px solid var(--grid); }
    .cell[data-c="3"], .cell[data-c="6"]{ border-right:2px solid var(--grid); }

    /* Highlights */
    .cell.noteMatch1{background:var(--hl-note1-match)}
    .cell.noteMatch2{background:var(--hl-note2-match)}
    .cell.sameNumRC{background:var(--hl-same-rc)}
    .cell.sameNum{background:var(--hl-same)}
    .cell.selected{background:var(--hl-selected);box-shadow:inset 0 0 0 2px var(--grid);} .cell.related{background:var(--hl-selected)}
    .cell.error input{color:var(--error)}

    .pad-title{font-size:14px;color:var(--muted);margin:12px 0 8px}
    .pad{display:grid;grid-template-columns:repeat(9,1fr);gap:8px}
    .key{display:grid;place-items:center;height:44px;border-radius:14px;background:var(--card);border:1px solid var(--border);font-weight:800;cursor:pointer}

    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

    /* ===== Modal ===== */
    .modal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.35);}
    .modal.open{display:block}
    .panel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--card);color:var(--text);padding:16px;border:1px solid var(--border);border-radius:16px;box-shadow:0 28px 60px rgba(0,0,0,.3);max-width:680px;width:calc(100% - 24px)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .panel label{font-size:12px;color:var(--muted)}
    .panel input[type='color']{width:100%;height:40px;border:1px solid var(--border);border-radius:8px;background:var(--card)}
    .switch{display:flex;align-items:center;gap:8px}
    .swatches{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .swatch{width:28px;height:24px;border-radius:6px;border:1px solid var(--border);cursor:pointer;outline-offset:2px}
    .swatch.is-selected{outline:3px solid var(--accent)}
  </style>
</head>
<body class="theme-light">
  <div class="wrap" id="appRoot">

    <!-- ===== STARTSK√ÑRM ===== -->
    <section id="screenStart" class="screen active">
      <h1>Sudoku <small class="ver" id="verStart"></small></h1>
      <div class="card">
        <h2 style="margin:4px 0 10px">Nytt spel</h2>
        <div class="grid4">
          <button class="btn primary" data-new="easy">L√§tt</button>
          <button class="btn primary" data-new="medium">Medel</button>
          <button class="btn primary" data-new="hard">Sv√•r</button>
          <button class="btn primary" data-new="master">M√§stare</button>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:4px 0 10px">Forts√§tt</h2>
        <div id="slotList" class="col" style="display:grid;gap:8px"></div>
      </div>

      <div class="card">
        <h2 style="margin:4px 0 10px">Statistik</h2>
        <div class="stats-grid">
          <div class="stat"><strong id="statStarted">0</strong><div>Startade</div></div>
          <div class="stat"><strong id="statCleared">0</strong><div>Klara</div></div>
          <div class="stat"><strong id="statAvg">0</strong><div>Snitt misstag</div></div>
          <div class="stat"><strong id="statBest">-</strong><div>B√§sta (minst)</div></div>
        </div>
      </div>
    </section>

    <!-- ===== SPELSK√ÑRM ===== -->
    <section id="screenGame" class="screen">
      <header class="game">
        <div class="top-left">
          <h1>Sudoku <small class="ver" id="verGame"></small> <small class="diff" id="diffInline"></small></h1>
        </div>
        <div class="stats">
          <div>Misstag: <span id="mistakes" class="num">0</span></div>
          <div>Tomma: <span id="empties" class="num">81</span></div>
        </div>
        <div class="top-right">
          <button id="btnHome" class="btn">Hem</button>
          <button id="btnCheck" class="btn">Kontrollera</button>
          <button id="btnSettings" class="btn icon" title="Inst√§llningar" aria-label="Inst√§llningar">‚öôÔ∏è</button>
        </div>
      </header>

      <div class="board-wrap"><div id="board" class="board" aria-live="polite"></div></div>

      <div class="pad-title">Huvudsiffror</div>
      <div id="padMain" class="pad"></div>

      <div class="pad-title">Anteckningar 1</div>
      <div id="padN1" class="pad"></div>

      <div class="pad-title">Anteckningar 2</div>
      <div id="padN2" class="pad"></div>

      <div class="actions">
        <button id="undo" class="btn" title="√Öngra" aria-label="√Öngra">‚Ü∂</button>
        <button id="redo" class="btn" title="G√∂r om" aria-label="G√∂r om">‚Ü∑</button>
        <button id="eraseMain" class="btn" title="Radera huvud" aria-label="Radera huvud">‚å´</button>
        <button id="eraseN1" class="btn" title="Radera anteckningar 1" aria-label="Radera anteckningar 1">‚®Ø</button>
        <button id="eraseN2" class="btn" title="Radera anteckningar 2" aria-label="Radera anteckningar 2">‚®Ø</button>
        <button id="hint" class="btn" title="Hint" aria-label="Hint">üí°</button>
      </div>

      <div class="status" id="status">V√§lj en ruta.</div>
    </section>
  </div>

  <!-- ===== Settings Modal ===== -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="panel">
      <h2 id="settingsTitle">Inst√§llningar</h2>

      <div class="switch" style="margin:8px 0 12px 0">
        <label for="themeSelect" style="min-width:80px">Tema</label>
        <select id="themeSelect">
          <option value="light">Ljust</option>
          <option value="dark">M√∂rkt</option>
        </select>
      </div>

      <div class="switch" style="margin:0 0 16px 0">
        <input type="checkbox" id="liveValidate" />
        <label for="liveValidate">Validering i realtid (Direkt). Av = endast vid "Kontrollera"</label>
      </div>

      <div class="grid2">
        <div>
          <label>Rutn√§t</label>
          <input type="color" id="c-grid" value="#111111">
          <div id="sw-grid" class="swatches"></div>
        </div>
        <div>
          <label>F√∂rinskrivna</label>
          <input type="color" id="c-prefill" value="#111111">
        </div>
        <div>
          <label>Huvudsiffror</label>
          <input type="color" id="c-main" value="#1b3e8a">
        </div>
        <div>
          <label>Anteckningar 1</label>
          <input type="color" id="c-note1" value="#ff0000">
        </div>
        <div>
          <label>Anteckningar 2</label>
          <input type="color" id="c-note2" value="#2fa568">
        </div>

        <div>
          <label>Markerad rad/kolumn/box</label>
          <input type="color" id="c-hl-selected" value="#e8f0ff">
          <div id="sw-hl-selected" class="swatches"></div>
        </div>
        <div>
          <label>Samma siffra</label>
          <input type="color" id="c-hl-same" value="#f3f7ff">
          <div id="sw-hl-same" class="swatches"></div>
        </div>
      </div>

      <div class="row" style="justify-content:end;margin-top:12px">
        <button id="closeSettings" class="btn">St√§ng</button>
      </div>
    </div>
  </div>

  <!-- (V√§lj sv√•righet-modal finns kvar i DOM men anv√§nds inte l√§ngre) -->
  <div id="chooseModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="chooseTitle">
    <div class="panel">
      <h2 id="chooseTitle">V√§lj sv√•righet</h2>
      <div id="chooseList" class="col"></div>
      <div class="row" style="justify-content:end;margin-top:12px"><button id="chooseCancel" class="btn">Avbryt</button></div>
    </div>
  </div>

  <script>
  const APP_VERSION = "v. 0.9.5";

  /* ======= Data (pussel), state & storage ======= */
  const PUZZLES = {
    easy:[
      {p:"530070000600195000098000060800060003400803001700020006060000280000419005000080079", s:"534678912672195348198342567859761423426853791713924856961537284287419635345286179"},
      {p:"096040001078006000300900060000050007020400000001000200010060000000302080500010430", s:"296543871178296543345971268634852917729413685851769234412637859967328154583194726"},
      {p:"700060030010200705000000040000600059300050000060000100000009070800000006047030000", s:"728564931413298765596371842281647359374159286965823174652916473839745612147432598"},
    ],
    medium:[
      {p:"060020000000000003901050040050090007000007090040030080006010004500000000000080600", s:"864329175725641893931758246553496817218567394647132985686913524579284631342875169"},
      {p:"000060009300000100050400300002030001000902000600040500004007030005000004100050000", s:"248163759369275148751498362492537681817962435635841527984716253576329814123654976"},
      {p:"008010030002005600600080000000000409900060000000009200020000080007020000000300001", s:"568412937472935618639781542251873469947126853386549274213694785897251346754368121"},
    ],
    hard:[
      {p:"005300000800000020070010500400005300010000040003200001001000068000070000000006200", s:"145329876836147925972816543426785319718963542593214781251492638689573214347658291"},
      {p:"300000000005009008200005401000020000040810050000090000709400003800500200000000004", s:"391248567475169328286735491538627149749813256162594873719482635834576912625391784"},
      {p:"000000907020000003003070000600030020010000040040080009000040200700000030304000000", s:"816452937427916583953873416675394128219768345348285679568741292791628354234539861"},
    ],
    master:[
      {p:"000000000000010200070006000600000003008000700900000005000400020007020000000000000", s:"819247356436519278275836914651972843328154769947683125183495627764321589592768431"},
      {p:"010000000000600000008000340000700000700000006000003000081000900000004000000000050", s:"317249865492685731568137349836721594745896126129453678681572943274964813953318452"},
      {p:"000048000008000010010000000030000090000502000040000070000000050070000100000920000", s:"327148569568279413914635827253417698786592341149863275892761354475386192631924786"},
    ],
  };

  function nowTs(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`; }

  function defaultStats(){ return { started:0, completed:0, totalMistakes:0, bestMistakes:null }; }
  function defaultSlots(){ return [null,null,null].map(()=> ({ locked:false, savedAt:null, difficulty:null, state:null })); }

  const KEY_APP = 'sudoku.app.v1';
  const KEY_THEME = 'sudoku.theme.v1';
  const KEY_THEMEVARS = 'sudoku.themevars.v1';

  function loadApp(){
    let obj; try{ obj = JSON.parse(localStorage.getItem(KEY_APP)||''); }catch{ obj=null; }
    if(!obj){ obj = { stats: defaultStats(), slots: defaultSlots() }; }
    if(!obj.stats) obj.stats = defaultStats();
    if(!obj.slots) obj.slots = defaultSlots();
    return obj;
  }
  function saveApp(){ localStorage.setItem(KEY_APP, JSON.stringify(store)); }

  function loadTheme(){ return localStorage.getItem(KEY_THEME) || 'light'; }
  function saveTheme(t){ localStorage.setItem(KEY_THEME, t); }
  function loadThemeVars(){ try{ return JSON.parse(localStorage.getItem(KEY_THEMEVARS)||'{}'); }catch{return {}} }
  function saveThemeVars(v){ localStorage.setItem(KEY_THEMEVARS, JSON.stringify(v)); }

  // UI refs
  const screenStart = document.getElementById('screenStart');
  const screenGame  = document.getElementById('screenGame');
  const boardEl = document.getElementById('board');
  const statusEl = document.getElementById('status');
  const mistakesEl = document.getElementById('mistakes');
  const emptiesEl = document.getElementById('empties');
  const diffTag = document.getElementById('diffInline');

  const buttons = {
    home: document.getElementById('btnHome'),
    check: document.getElementById('btnCheck'),
    undo: document.getElementById('undo'),
    redo: document.getElementById('redo'),
    eraseMain: document.getElementById('eraseMain'),
    eraseN1: document.getElementById('eraseN1'),
    eraseN2: document.getElementById('eraseN2'),
    hint: document.getElementById('hint'),
    settings: document.getElementById('btnSettings'),
  };
  const pads = { main: document.getElementById('padMain'), n1: document.getElementById('padN1'), n2: document.getElementById('padN2') };

  // visa version i rubrikerna
  document.querySelectorAll('.ver').forEach(el=> el.textContent = APP_VERSION);

  const modal = document.getElementById('modal');
  const chooseModal = document.getElementById('chooseModal');
  const chooseList = document.getElementById('chooseList');
  const chooseCancel = document.getElementById('chooseCancel');
  const appRoot = document.getElementById('appRoot');
  const themeSelect = document.getElementById('themeSelect');
  const liveValidateChk = document.getElementById('liveValidate');

  const colorInputs = {
    grid: document.getElementById('c-grid'),
    prefill: document.getElementById('c-prefill'),
    main: document.getElementById('c-main'),
    note1: document.getElementById('c-note1'),
    note2: document.getElementById('c-note2'),
    hlSelected: document.getElementById('c-hl-selected'),
    hlSame: document.getElementById('c-hl-same'),
  };

  const gridSw = document.getElementById('sw-grid');
  const hlSelSw = document.getElementById('sw-hl-selected');
  const hlSameSw = document.getElementById('sw-hl-same');

  function makeSwatches(el, arr, onPick){ el.innerHTML=''; arr.forEach(col=>{ const b=document.createElement('button'); b.className='swatch'; b.style.background=col; b.onclick=()=> onPick(col,b); el.appendChild(b); }); }

  function applyThemeVars(vars){
    const set=(k,v)=> document.body.style.setProperty(k, v);
    if(vars.grid) set('--grid', vars.grid);
    if(vars.prefill) set('--prefill', vars.prefill);
    if(vars.main) set('--main', vars.main);
    if(vars.note1) set('--note1', vars.note1);
    if(vars.note2) set('--note2', vars.note2);
    if(vars.hlSelected) set('--hl-selected', vars.hlSelected);
    if(vars.hlSame) set('--hl-same', vars.hlSame);
  }

  // demo swatches
  const greys = ['#111111','#1f2937','#374151','#6b7280','#9ca3af','#cbd5e1','#e5e7eb','#f9fafb'];
  makeSwatches(gridSw, greys, (col,btn)=>{ document.body.style.setProperty('--grid', col); selectSwatch(gridSw,btn); commitThemeVars(); renderBoard(); });
  makeSwatches(hlSelSw, ['#e8f0ff','#14223d','#dbeafe','#eef2ff'], (c,b)=>{ document.body.style.setProperty('--hl-selected', c); selectSwatch(hlSelSw,b); commitThemeVars(); drawHighlights(); });
  makeSwatches(hlSameSw, ['#f3f7ff','#1a2744','#e2e8f0','#e0e7ff'], (c,b)=>{ document.body.style.setProperty('--hl-same', c); selectSwatch(hlSameSw,b); commitThemeVars(); drawHighlights(); });
  function selectSwatch(container, btn){ container.querySelectorAll('.swatch').forEach(x=>x.classList.remove('is-selected')); btn.classList.add('is-selected'); }

  function commitThemeVars(){ const v = {
    grid:getComputedStyle(document.body).getPropertyValue('--grid').trim(),
    prefill:getComputedStyle(document.body).getPropertyValue('--prefill').trim(),
    main:getComputedStyle(document.body).getPropertyValue('--main').trim(),
    note1:getComputedStyle(document.body).getPropertyValue('--note1').trim(),
    note2:getComputedStyle(document.body).getPropertyValue('--note2').trim(),
    hlSelected:getComputedStyle(document.body).getPropertyValue('--hl-selected').trim(),
    hlSame:getComputedStyle(document.body).getPropertyValue('--hl-same').trim(),
  }; saveThemeVars(v); }

  // ===== App state =====
  let store = loadApp();
  let currentSlot = null; // 0..2 eller null

  function labelForDiff(d){ return ({easy:'L√§tt',medium:'Medel',hard:'Sv√•r',master:'M√§stare'})[d]||d; }

  let state = { difficulty:'easy', puzzle:'', solution:'', fixed:new Set(), values:Array(81).fill(0), notes1:Array.from({length:81},()=>new Set()), notes2:Array.from({length:81},()=>new Set()), mistakes:0, live:false, sel:0, history:[], redo:[] };

  function setStatus(t){ statusEl.textContent = t; }

  function updateStatsUI(){
    document.getElementById('statStarted').textContent = store.stats.started;
    document.getElementById('statCleared').textContent = store.stats.completed;
    document.getElementById('statAvg').textContent = store.stats.completed? (Math.round((store.stats.totalMistakes/store.stats.completed)*10)/10) : 0;
    document.getElementById('statBest').textContent = store.stats.bestMistakes==null? '-' : store.stats.bestMistakes;
  }

  function renderSlots(){
    const list = document.getElementById('slotList'); list.innerHTML='';
    store.slots.forEach((s,i)=>{
      const row=document.createElement('div'); row.className='slot';
      const left=document.createElement('div');
      if(s && s.state){
        left.innerHTML = `<div><b>Plats ${i+1}</b></div><div class="meta">${labelForDiff(s.difficulty)} ¬∑ ${s.savedAt||''}</div>`;
      }else{
        left.innerHTML = `<div><b>Plats ${i+1}</b> <span class="meta">tom</span></div>`;
      }
      const b1=document.createElement('button'); b1.className='btn'; b1.textContent='Forts√§tt'; b1.disabled = !(s && s.state); b1.onclick=()=> loadSlotToGame(i);
      const b2=document.createElement('button'); b2.className='btn'; b2.textContent= s?.locked ? 'L√•st' : 'L√•s'; b2.onclick=()=> toggleLock(i);
      const b3=document.createElement('button'); b3.className='btn'; b3.textContent='Radera'; b3.onclick=()=> removeSlot(i);
      row.append(left,b1,b2,b3); list.appendChild(row);
    });
  }

  function toggleLock(i){
    const s = store.slots[i]; if(!s) { store.slots[i] = { locked:false, savedAt:null, difficulty:null, state:null }; }
    const lockedCount = store.slots.filter(x=>x?.locked).length;
    if(!store.slots[i].locked && lockedCount>=2){ alert('Max tv√• l√•sta.'); return; }
    store.slots[i].locked = !store.slots[i].locked; saveApp(); renderSlots();
  }
  function removeSlot(i){ store.slots[i] = { locked:false, savedAt:null, difficulty:null, state:null }; saveApp(); renderSlots(); }

  function loadSlotToGame(idx){
    const slot = store.slots[idx]; if(!slot || !slot.state) return;
    currentSlot = idx;
    const s = slot.state;
    state = { ...state, difficulty:slot.difficulty, puzzle:s.puzzle, solution:s.solution, fixed:new Set(s.fixed), values:s.values.slice(), notes1:s.notes1.map(a=>new Set(a)), notes2:s.notes2.map(a=>new Set(a)), mistakes:s.mistakes||0, live:s.live??false, history:[], redo:[] };
    showGame(); renderBoard(); mistakesEl.textContent=String(state.mistakes); diffTag.textContent = 'Sv√•righet: ' + labelForDiff(state.difficulty); refreshHighlights(); setStatus('√Öterupptaget.'); updateEmpties();
  }

  function startNewGame(diff, slotIndex){
    const list = PUZZLES[diff] || [];
    const p = list[Math.floor(Math.random()*list.length)];
    if(!p){ alert('Inga pussel f√∂r '+diff); return; }
    state = { difficulty:diff, puzzle:p.p, solution:p.s, fixed:new Set(), values:Array(81).fill(0), notes1:Array.from({length:81},()=>new Set()), notes2:Array.from({length:81},()=>new Set()), mistakes:0, live:liveValidateChk.checked, history:[], redo:[] };
    for(let i=0;i<81;i++) if(p.p[i]!== '0') state.fixed.add(i);
    currentSlot = slotIndex;
    // stats
    store.stats.started += 1; saveApp(); updateStatsUI();
    saveActive();
    showGame(); renderBoard(); mistakesEl.textContent='0'; diffTag.textContent = 'Sv√•righet: ' + labelForDiff(diff); setStatus('V√§lj en ruta.'); updateEmpties();
  }

  function saveActive(){
    if(currentSlot==null) return;
    const snapshot = { puzzle:state.puzzle, solution:state.solution, fixed:[...state.fixed], values:state.values, notes1:state.notes1.map(s=>[...s]), notes2:state.notes2.map(s=>[...s]), mistakes:state.mistakes, live:state.live, sel:state.sel };
    store.slots[currentSlot] = { locked: store.slots[currentSlot]?.locked||false, savedAt: nowTs(), difficulty: state.difficulty, state: snapshot };
    saveApp(); renderSlots();
  }

  function showStart(){ screenGame.classList.remove('active'); screenStart.classList.add('active'); renderSlots(); updateStatsUI(); }
  function showGame(){ screenStart.classList.remove('active'); screenGame.classList.add('active'); }

  buttons.home.addEventListener('click', showStart);

  /* ===== Br√§de & UI ===== */
  function clearBoard(){ boardEl.innerHTML=''; }
  function renderBoard(){
    clearBoard();
    for(let r=0;r<9;r++) for(let c=0;c<9;c++){
      const i=id(r,c);
      const cell=document.createElement('div'); cell.className='cell'; cell.dataset.r=r+1; cell.dataset.c=c+1; cell.dataset.i=i;
      const input=document.createElement('input'); input.setAttribute('inputmode','none'); input.setAttribute('readonly','');
      input.value= state.fixed.has(i) ? String(pChar(state.puzzle,i)) : (state.values[i] ? String(state.values[i]) : '');
      if(state.fixed.has(i)) cell.classList.add('readonly');
      cell.appendChild(input);
      cell.addEventListener('click',()=> selectCell(i));
      cell.addEventListener('keydown', onCellKey);
      boardEl.appendChild(cell);
    }
    document.querySelectorAll('.cell').forEach(el=>{ const r=+el.dataset.r, c=+el.dataset.c; if(r%3===0) el.setAttribute('data-r', String(r)); if(c%3===0) el.setAttribute('data-c', String(c)); });
    drawHighlights();
  }

  function pChar(p,i){ return +p[i] || 0; }

  function drawHighlights(){
    const cells=[...document.querySelectorAll('.cell')];
    cells.forEach(el=> el.classList.remove('selected','related','sameNum','sameNumRC','noteMatch1','noteMatch2','error'));
    const [r,c]=rc(state.sel);
    const v=state.values[state.sel];
    cells[state.sel]?.classList.add('selected');
    for(let k=0;k<9;k++){ cells[id(r,k)]?.classList.add('related'); cells[id(k,c)]?.classList.add('related'); }
    const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3; for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) cells[id(br+rr,bc+cc)]?.classList.add('related');
    if(v){
      for(let i=0;i<81;i++) if(state.values[i]===v) cells[i]?.classList.add('sameNum');
      for(let k=0;k<9;k++){ if(state.values[id(r,k)]===v) cells[id(r,k)].classList.add('sameNumRC'); if(state.values[id(k,c)]===v) cells[id(k,c)].classList.add('sameNumRC'); }
    }
    if(state.live) validateConflicts();
  }

  function onCellKey(e){
    const k=e.key;
    if(k>='1' && k<='9'){ setMain(+k); e.preventDefault(); return; }
    if(k==='Backspace' || k==='Delete'){ clearMain(); e.preventDefault(); return; }
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(k)){
      e.preventDefault();
      const [r,c]=rc(state.sel); let nr=r, nc=c;
      if(k==='ArrowUp') nr=(r+8)%9; if(k==='ArrowDown') nr=(r+1)%9; if(k==='ArrowLeft') nc=(c+8)%9; if(k==='ArrowRight') nc=(c+1)%9;
      selectCell(id(nr,nc));
    }
  }

  function selectCell(i){ state.sel=i; drawHighlights(); document.querySelectorAll('.cell')[i]?.focus(); }

  function setMain(n){
    const i=state.sel; if(state.fixed.has(i)) return;
    const prev=state.values[i]; if(prev===n) return;
    pushUndo({t:'set',i,prev,val:n}); state.values[i]=n; clearNotes(i,n); drawHighlights(); updateEmpties(); saveActive();
  }
  function clearMain(){ const i=state.sel; if(state.fixed.has(i)) return; const prev=state.values[i]; if(!prev) return; pushUndo({t:'set',i,prev,val:0}); state.values[i]=0; drawHighlights(); updateEmpties(); saveActive(); }

  function clearNotes(i,n){
    for(let k=0;k<9;k++){ state.notes1[id(rc(i)[0],k)].delete(n); state.notes2[id(k,rc(i)[1])].delete(n); }
    const br=Math.floor(rc(i)[0]/3)*3, bc=Math.floor(rc(i)[1]/3)*3; for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++){ const j=id(br+rr,bc+cc); state.notes1[j].delete(n); state.notes2[j].delete(n); }
  }

  function onNum(n,layer){ if(layer==='main'){ setMain(n); } else { const set = layer==='n1'? state.notes1[state.sel] : state.notes2[state.sel]; if(state.values[state.sel]) return; if(set.has(n)) set.delete(n); else set.add(n); drawHighlights(); saveActive(); } }

  function makePad(el, layer){ el.innerHTML=''; for(let n=1;n<=9;n++){ const b=document.createElement('button'); b.className='key'; b.textContent=String(n); b.onclick=()=> onNum(n, layer); el.appendChild(b); } }

  function pushUndo(a){ state.history.push(a); state.redo.length=0; }
  function doUndo(){ const a=state.history.pop(); if(!a) return; state.redo.push(a); if(a.t==='set'){ state.values[a.i]=a.prev; } if(a.t==='note'){ const set= a.layer==='n1'? state.notes1[a.i] : state.notes2[a.i]; if(a.prev) set.add(a.n); else set.delete(a.n);} drawHighlights(); updateEmpties(); saveActive(); }
  function doRedo(){ const a=state.redo.pop(); if(!a) return; state.history.push(a); if(a.t==='set'){ state.values[a.i]=a.val; } if(a.t==='note'){ const set= a.layer==='n1'? state.notes1[a.i] : state.notes2[a.i]; if(a.prev) set.delete(a.n); else set.add(a.n);} drawHighlights(); updateEmpties(); saveActive(); }

  function groupDuplicates(idxList){ const map={}; idxList.forEach(i=>{ const v=state.values[i]; if(!v) return; (map[v] ||= []).push(i); }); return Object.values(map).filter(a=>a.length>1).flat(); }
  function validateConflicts(){ document.querySelectorAll('.cell').forEach(c=>c.classList.remove('error')); for(let r=0;r<9;r++) mark(groupDuplicates([...Array(9)].map((_,c)=> id(r,c)))); for(let c=0;c<9;c++) mark(groupDuplicates([...Array(9)].map((_,r)=> id(r,c)))); for(let br=0;br<3;br++) for(let bc=0;bc<3;bc++){ const arr=[]; for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) arr.push(id(br*3+rr, bc*3+cc)); mark(groupDuplicates(arr)); } function mark(list){ list.forEach(i=> document.querySelectorAll('.cell')[i]?.classList.add('error')); }}
  function onCheck(){ const before=document.querySelectorAll('.cell.error').length; validateConflicts(); const after=document.querySelectorAll('.cell.error').length; if(after>0) state.mistakes++; mistakesEl.textContent=String(state.mistakes); saveActive(); checkSolved(); }
  function checkSolved(){ if(updateEmpties()!==0) return; if(!isValid(state.values)) return; store.stats.completed += 1; store.stats.totalMistakes += state.mistakes; if(store.stats.bestMistakes==null) store.stats.bestMistakes = state.mistakes; else store.stats.bestMistakes = Math.min(store.stats.bestMistakes, state.mistakes); saveApp(); alert('Grattis!'); showStart(); }

  function updateEmpties(){ let n=0; for(const v of state.values) if(!v) n++; emptiesEl.textContent=String(n); return n; }
  function isValid(b){ for(let r=0;r<9;r++){ const s=new Set(); for(let c=0;c<9;c++){ const v=b[id(r,c)]; if(v<1||v>9||s.has(v)) return false; s.add(v);} } for(let c=0;c<9;c++){ const s=new Set(); for(let r=0;r<9;r++){ const v=b[id(r,c)]; if(v<1||v>9||s.has(v)) return false; s.add(v);} } for(let br=0;br<3;br++) for(let bc=0;bc<3;bc++){ const s=new Set(); for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++){ const v=b[id(br*3+rr, bc*3+cc)]; if(v<1||v>9||s.has(v)) return false; s.add(v);} } return true; }

  function rc(i){ return [Math.floor(i/9), i%9]; }
  function id(r,c){ return r*9+c; }

  // Pads
  makePad(pads.main,'main');
  makePad(pads.n1,'n1');
  makePad(pads.n2,'n2');

  // Buttons
  buttons.undo.onclick=doUndo;
  buttons.redo.onclick=doRedo;
  document.getElementById('eraseMain').onclick=()=>{ clearMain(); };
  document.getElementById('eraseN1').onclick=()=>{ const s=state.notes1[state.sel]; if(!s.size) return; state.history.push({t:'note',layer:'n1',n:null,prev:[...s],i:state.sel}); s.clear(); drawHighlights(); saveActive(); };
  document.getElementById('eraseN2').onclick=()=>{ const s=state.notes2[state.sel]; if(!s.size) return; state.history.push({t:'note',layer:'n2',n:null,prev:[...s],i:state.sel}); s.clear(); drawHighlights(); saveActive(); };
  buttons.hint.onclick=()=>{ for(let i=0;i<81;i++){ if(state.values[i]) continue; const cs=candsAt(i); if(cs.length===1){ selectCell(i); setMain(cs[0]); return; } } alert('Inga enkla tips just nu.'); };

  function candsAt(i){ const [r,c]=rc(i); const taken=new Set(); for(let k=0;k<9;k++){ taken.add(state.values[id(r,k)]); taken.add(state.values[id(k,c)]);} const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3; for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) taken.add(state.values[id(br+rr,bc+cc)]); const res=[]; for(let n=1;n<=9;n++) if(!taken.has(n)) res.push(n); return res; }

  // Settings
  function openSettings(){ modal.classList.add('open'); appRoot.setAttribute('inert',''); }
  function closeSettings(){ modal.classList.remove('open'); appRoot.removeAttribute('inert'); commitThemeVars(); }
  buttons.settings.onclick=openSettings; document.getElementById('closeSettings').onclick=closeSettings;

  themeSelect.value = loadTheme();
  document.body.classList.toggle('theme-dark', themeSelect.value==='dark');
  themeSelect.onchange = ()=>{ const val=themeSelect.value; document.body.classList.toggle('theme-dark', val==='dark'); saveTheme(val); };

  // Theme vars restore
  applyThemeVars(loadThemeVars());

  // Startsk√§rm: knappar startar direkt (ingen extra meny)
  document.querySelectorAll('[data-new]').forEach(btn=> btn.onclick = ()=> startNewGame(btn.dataset.new, findSlotToUse()));

  function findSlotToUse(){ for(let i=0;i<3;i++) if(!store.slots[i]?.state && !store.slots[i]?.locked) return i; for(let i=0;i<3;i++) if(!store.slots[i]?.locked) return i; return 0; }

  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSettings(); });

  /* ===== Init ===== */
  function init(){ renderSlots(); updateStatsUI(); buildPads(); }
  function buildPads(){ ['main','n1','n2'].forEach(()=>{}); }
  init();

  function updateEmpties(){ let n=0; for(let i=0;i<81;i++) if(!state.values[i]) n++; emptiesEl.textContent=String(n); return n; }

  function updateEmptiesHeader(){ emptiesEl.textContent = String(state.values.filter(v=>!v).length); }

  /* ===== Service Worker ===== */
  if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(()=>{})); }
  </script>
</body>
</html>
