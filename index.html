<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Sudoku</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">

<style>
:root{
  /* Tema-variabler (sparas/uppdateras i Inst√§llningar) */
  --bg: #ffffff;
  --fg: #111111;
  --grid: #000000;
  --given: #000000;
  --main: #1d4ed8;    /* bl√• */
  --note1: #ff0000;   /* r√∂d (mobilv√§nlig) */
  --note2: #16a34a;   /* gr√∂n */
  --hl-rcb: #e9e9ff;  /* rad/kol/box highlight */
  --hl-same: #e4e7ff; /* samma siffra highlight */
  --cell-selected: #c7d2fe;
  --error: #ffebee;

  --cell-size: min(9.6vw, 44px);
  --gap: 10px;
  --radius: 14px;
  --shadow: 0 6px 18px rgba(0,0,0,.08);
}

@media (prefers-color-scheme: dark){
  :root{
    --bg:#0b0b0f; --fg:#f5f5f7;
    --grid:#f5f5f5; --given:#f5f5f5;
    --hl-rcb:#202033; --hl-same:#27274a;
    --cell-selected:#3943a3; --error:#4c1d1d;
  }
}

html,body{height:100%}
body{
  margin:0;
  font:16px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, sans-serif;
  background:var(--bg);
  color:var(--fg);
}

/* ---------- App Layout ---------- */
.wrap{max-width:1024px;margin-inline:auto;padding:16px}
h1{margin:0;font-weight:700;letter-spacing:.2px}
h1 small{font-weight:600;opacity:.8;margin-left:.5ch}
section{margin-block:18px}

/* ---------- Start Screen ---------- */
.card{
  background:rgba(127,127,127,.06);
  border:1px solid rgba(127,127,127,.18);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:16px;
}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media (max-width:720px){.grid-2{grid-template-columns:1fr}}

.btn{
  appearance:none;border:0;border-radius:18px;padding:12px 16px;
  background:#eef2ff;color:#111;font-weight:600;
  box-shadow:var(--shadow);cursor:pointer
}
.btn:active{transform:translateY(1px)}
.btn.primary{background:#dbeafe}
.btn.blue{background:#dbeafe}
.btn.red{background:#fee2e2}
.btn.green{background:#dcfce7}
.btn.gray{background:#f1f5f9}
.btn.icon{padding:10px 14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

.list{display:grid;gap:10px}
.slot{display:flex;justify-content:space-between;align-items:center;gap:10px;background:rgba(127,127,127,.06);padding:10px;border-radius:12px;border:1px solid rgba(127,127,127,.2)}
.slot b{font-weight:700}
.kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi .box{background:rgba(127,127,127,.06);border:1px solid rgba(127,127,127,.2);border-radius:12px;padding:12px;text-align:center}
.kpi .val{font-size:20px;font-weight:800}

/* ---------- Game Header (two rows) ---------- */
header.game{
  display:grid;
  grid-template-columns: 1fr auto;
  grid-template-rows: auto auto;
  grid-template-areas:
    "title actions"
    "stats actions";
  gap:6px 10px;
  align-items:center;
  margin-bottom:12px;
}
.top-left{grid-area:title;display:flex;gap:.6ch;align-items:baseline;flex-wrap:wrap}
.top-right{grid-area:actions;display:flex;gap:8px;justify-self:end;flex-wrap:wrap}
.stats{grid-area:stats;display:flex;gap:16px;flex-wrap:wrap}
.stats .num{font-weight:800}

/* ---------- Board ---------- */
.board{display:grid;grid-template-columns:repeat(9,var(--cell-size));grid-template-rows:repeat(9,var(--cell-size));gap:0;touch-action:manipulation;user-select:none;margin-inline:auto;border:2px solid var(--grid);border-radius:10px;overflow:hidden}
.cell{
  display:grid;place-items:center;position:relative;background:#fff0;
  border-right:1px solid var(--grid);border-bottom:1px solid var(--grid);
  outline:none;cursor:pointer;font-weight:720;
}
.cell[data-r="2"], .cell[data-r="5"]{box-shadow:0 2px 0 0 var(--grid) inset}
.cell[data-c="2"], .cell[data-c="5"]{box-shadow:2px 0 0 0 var(--grid) inset}
.cell.given{color:var(--given)}
.cell.main{color:var(--main)}
.cell .note1, .cell .note2{
  position:absolute;inset:3px;border-radius:6px;padding:2px;font-size:11px;line-height:1.05;display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:1fr;gap:1px;opacity:.95;pointer-events:none
}
.cell .note1{color:var(--note1)}
.cell .note2{color:var(--note2)}
.cell .n{display:grid;place-items:center}
.cell.selected{background:var(--cell-selected)}
.cell.rcb{background:var(--hl-rcb)}
.cell.same{background:var(--hl-same)}
.cell.error{background:var(--error)}
.cell:focus-visible{outline:2px solid #93c5fd;outline-offset:-2px}

/* ---------- Pads & Actions ---------- */
.pad-title{font-size:13px;opacity:.7;margin-top:14px}
.pad{display:grid;grid-template-columns:repeat(9,1fr);gap:10px}
.key{display:grid;place-items:center;border-radius:16px;height:44px;font-weight:800;background:#dbeafe;color:#0b1020;border:0;cursor:pointer;box-shadow:var(--shadow)}
.key.red{background:#fee2e2}
.key.green{background:#dcfce7}
.key.gray{background:#e2e8f0}
.key:active{transform:translateY(1px)}

.actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}

/* ---------- Settings Sheet ---------- */
.sheet{
  position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:flex-end;z-index:40
}
.sheet.open{display:flex}
.panel{
  background:var(--bg);color:var(--fg);border-radius:18px 18px 0 0;padding:16px 16px 24px;box-shadow:0 -20px 40px rgba(0,0,0,.25);width:100%;
  max-height:min(86vh,900px);overflow:auto;
}
.panel h2{margin-top:0}
.swatches{display:flex;gap:6px;flex-wrap:wrap}
.swatch{width:28px;height:22px;border-radius:6px;border:2px solid rgba(0,0,0,.15);cursor:pointer}
.row.mid{align-items:center}
label{display:block;margin:10px 0 6px}

hr{border:0;border-top:1px solid rgba(127,127,127,.25);margin:14px 0}
.small{font-size:12px;opacity:.75}
.hidden{display:none}

/* Accessibility helpers */
.visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
</style>
</head>
<body>

<div id="screen-start" class="wrap">
  <h1>Sudoku <small id="verStart"></small></h1>

  <section class="card">
    <h3>Nytt spel</h3>
    <div class="row">
      <button class="btn primary" data-new="easy">L√§tt</button>
      <button class="btn primary" data-new="medium">Medel</button>
      <button class="btn primary" data-new="hard">Sv√•r</button>
      <button class="btn primary" data-new="master">M√§stare</button>
    </div>
  </section>

  <section class="grid-2">
    <div class="card">
      <h3>Forts√§tt</h3>
      <div id="slots" class="list"></div>
      <div class="small">Max tv√• l√•sta. Autosparning sker l√∂pande.</div>
    </div>

    <div class="card">
      <h3>Statistik</h3>
      <div class="kpi">
        <div class="box"><div>Startade</div><div id="kpiStarted" class="val">0</div></div>
        <div class="box"><div>Klara</div><div id="kpiCleared" class="val">0</div></div>
        <div class="box"><div>Snitt misstag</div><div id="kpiAvg" class="val">0</div></div>
        <div class="box"><div>B√§sta (minst)</div><div id="kpiBest" class="val">0</div></div>
      </div>
    </div>
  </section>
</div>

<div id="screen-game" class="wrap hidden">
  <header class="game">
    <div class="top-left">
      <h1>Sudoku <small id="verGame"></small> <small id="diffInline"></small></h1>
    </div>

    <div class="stats">
      <div>Misstag: <span id="mistakes" class="num">0</span></div>
      <div>Tomma: <span id="empties" class="num">81</span></div>
    </div>

    <div class="top-right">
      <button id="btnHome" class="btn gray">Hem</button>
      <button id="btnCheck" class="btn blue">Kontrollera</button>
      <button id="btnSettings" class="btn icon gray" title="Inst√§llningar" aria-haspopup="dialog" aria-controls="sheet">‚öôÔ∏è</button>
    </div>
  </header>

  <div id="board" class="board" role="grid" aria-label="Sudoku-br√§de"></div>

  <div class="pad-title">Huvudsiffror</div>
  <div id="padMain" class="pad" aria-label="Siffror">
    <!-- 1..9 injected -->
  </div>

  <div class="pad-title">Anteckningar 1</div>
  <div id="padN1" class="pad"></div>

  <div class="pad-title">Anteckningar 2</div>
  <div id="padN2" class="pad"></div>

  <div class="actions">
    <button id="undo" class="btn gray">‚Ü∂ √Öngra</button>
    <button id="redo" class="btn gray">‚Ü∑ G√∂r om</button>
    <button id="eraseMain" class="btn red">‚å´ radera huvud</button>
    <button id="eraseN1" class="btn red">‚®Ø radera note1</button>
    <button id="eraseN2" class="btn red">‚®Ø radera note2</button>
    <button id="hint" class="btn green">üí° hint</button>
  </div>
</div>

<!-- Settings sheet -->
<div id="sheet" class="sheet" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 id="sheetTitle">Inst√§llningar</h2>
      <button id="closeSheet" class="btn gray">St√§ng</button>
    </div>

    <label for="selTheme">Tema</label>
    <select id="selTheme" class="btn gray" style="padding-right:28px">
      <option value="light">Ljust</option>
      <option value="dark">M√∂rkt</option>
      <option value="auto">F√∂lj system</option>
    </select>

    <div style="margin-top:10px">
      <label><input id="chkRealtime" type="checkbox"> Validering i realtid (Direkt).</label>
      <div class="small">Av = endast vid ‚ÄúKontrollera‚Äù.</div>
    </div>

    <hr>

    <h3>F√§rger</h3>

    <div class="row mid">
      <div style="min-width:110px">Rutn√§t</div>
      <div id="swGrid" class="swatches"></div>
    </div>

    <div class="row mid">
      <div style="min-width:110px">F√∂rinskrivna</div>
      <input id="colGiven" type="color" value="#000000" class="btn gray" style="width:64px;height:36px;padding:0">
    </div>

    <div class="row mid">
      <div style="min-width:110px">Huvudsiffror</div>
      <input id="colMain" type="color" value="#1d4ed8" class="btn gray" style="width:64px;height:36px;padding:0">
    </div>

    <div class="row mid">
      <div style="min-width:110px">Anteckningar 1</div>
      <input id="colN1" type="color" value="#ff0000" class="btn gray" style="width:64px;height:36px;padding:0">
    </div>

    <div class="row mid">
      <div style="min-width:110px">Anteckningar 2</div>
      <input id="colN2" type="color" value="#16a34a" class="btn gray" style="width:64px;height:36px;padding:0">
    </div>

    <hr>

    <h3>Bakgrundsmarkeringar</h3>
    <div class="row mid">
      <div style="min-width:160px">Markerad rad/kolumn/box</div>
      <input id="colHLrcb" type="color" value="#e9e9ff" class="btn gray" style="width:64px;height:36px;padding:0">
    </div>
    <div class="row mid">
      <div style="min-width:160px">Samma siffra</div>
      <input id="colHLsame" type="color" value="#e4e7ff" class="btn gray" style="width:64px;height:36px;padding:0">
    </div>
  </div>
</div>

<script>
/* =========================
   Sudoku PWA ‚Äì index.html
   ========================= */
const APP_VERSION = "v. 0.9.2";

/* ---- Storage Keys ---- */
const KEY_APP   = "sudoku.app.v1";
const KEY_THEME = "sudoku.theme.v1";
const KEY_VARS  = "sudoku.themevars.v1";

/* ---- Puzzles (81-chars, 0=tom) ---- */
const PUZZLES = {
  easy: [
"530070000600195000098000060800060003400803001700020006060000280000419005000080079",
"096040001078006000300900060000050007020400000001000200010060000000302080500010430",
"700060030010200705000000040000600059300050000060000100000009070800000006047030000"
  ],
  medium: [
"060020000000000003901050040050090007000007090040030080006010004500000000000080600",
"000060009300000100050400300002030001000902000600040500004007030005000004100050000",
"008010030002005600600080000000000409900060000000009200020000080007020000000300001"
  ],
  hard: [
"005300000800000020070010500400005300010000040003200001001000068000070000000006200",
"300000000005009008200005401000020000040810050000090000709400003800500200000000004",
"000000907020000003003070000600030020010000040040080009000040200700000030304000000"
  ],
  master: [
"000000000000010200070006000600000003008000700900000005000400020007020000000000000",
"010000000000600000008000340000700000700000006000003000081000900000004000000000050",
"000048000008000010010000000030000090000502000040000070000000050070000100000920000"
  ]
};

/* ---- State ---- */
const state = {
  screen: "start",            // or "game"
  current: null,              // active slot index: 0..2
  r: 0, c: 0,                 // selection
  realtime: false,
  undo: [], redo: [],
  board: Array(81).fill(0),
  given: Array(81).fill(false),
  note1: Array.from({length:81},()=>new Set()),
  note2: Array.from({length:81},()=>new Set()),
  mistakes: 0,
  difficulty: "easy"
};

/* ---- App Data (slots & stats) ---- */
function loadApp(){
  const def = {
    slots: [
      {locked:false, data:null},
      {locked:false, data:null},
      {locked:false, data:null}
    ],
    stats:{started:0, cleared:0, mistakesTotal:0, best:0}
  };
  let obj;
  try{ obj = JSON.parse(localStorage.getItem(KEY_APP)||""); }catch{ obj = null; }
  if(!obj) obj = def;
  return obj;
}
function saveApp(obj){ localStorage.setItem(KEY_APP, JSON.stringify(obj)); }

/* ---- Theme ---- */
function loadTheme(){
  const mode = localStorage.getItem(KEY_THEME) || "light";
  document.getElementById("selTheme").value = mode;
  applyTheme(mode);
  const vars = JSON.parse(localStorage.getItem(KEY_VARS)||"{}");
  setVar("--grid", vars.grid||getComputedStyle(document.documentElement).getPropertyValue("--grid"));
  document.getElementById("colGiven").value = rgbToHex(getVar("--given")||"#000000");
  document.getElementById("colMain").value  = rgbToHex(getVar("--main") ||"#1d4ed8");
  document.getElementById("colN1").value    = rgbToHex(getVar("--note1")||"#ff0000");
  document.getElementById("colN2").value    = rgbToHex(getVar("--note2")||"#16a34a");
  document.getElementById("colHLrcb").value = rgbToHex(getVar("--hl-rcb")||"#e9e9ff");
  document.getElementById("colHLsame").value= rgbToHex(getVar("--hl-same")||"#e4e7ff");
}
function applyTheme(mode){
  const root = document.documentElement;
  root.dataset.theme = mode;
  localStorage.setItem(KEY_THEME, mode);
}
function setVar(k,v){ if(!v) return; document.documentElement.style.setProperty(k, v); persistVars(); }
function getVar(k){ return getComputedStyle(document.documentElement).getPropertyValue(k).trim(); }
function persistVars(){
  const vars = {
    grid:getVar("--grid"), given:getVar("--given"), main:getVar("--main"),
    note1:getVar("--note1"), note2:getVar("--note2"),
    rcb:getVar("--hl-rcb"), same:getVar("--hl-same")
  };
  localStorage.setItem(KEY_VARS, JSON.stringify(vars));
}

/* ---- UI Helpers ---- */
const qs = s=>document.querySelector(s);
const qsa = s=>Array.from(document.querySelectorAll(s));
function idx(r,c){ return r*9+c; }
function rc(i){ return [Math.floor(i/9), i%9]; }
function inBox(r,c){ return {br:Math.floor(r/3), bc:Math.floor(c/3)}; }
function clearChildren(el){ while(el.firstChild) el.removeChild(el.firstChild); }

/* ---- Screens ---- */
function showStart(){
  state.screen="start";
  qs("#screen-start").classList.remove("hidden");
  qs("#screen-game").classList.add("hidden");
  renderSlots();
  renderKPI();
}
function showGame(){
  state.screen="game";
  qs("#screen-start").classList.add("hidden");
  qs("#screen-game").classList.remove("hidden");
}

/* ---- Build Start Screen ---- */
function renderSlots(){
  const app = loadApp();
  const wrap = qs("#slots"); clearChildren(wrap);
  app.slots.forEach((s,i)=>{
    const div = document.createElement("div"); div.className="slot";
    const left = document.createElement("div");
    left.innerHTML = s.data
      ? `<b>Plats ${i+1}</b> ‚Äî ${labelDiff(s.data.difficulty)} ‚Ä¢ ${s.data.empties??countEmpties(s.data.board)} tomma`
      : `<b>Plats ${i+1}</b> <span class="small">tom</span>`;
    const right = document.createElement("div"); right.className="row";
    const btnC = document.createElement("button"); btnC.className="btn"; btnC.textContent="Forts√§tt";
    btnC.disabled = !s.data; btnC.onclick=()=>{ loadSlot(i); };
    const btnL = document.createElement("button"); btnL.className="btn gray"; btnL.textContent= s.locked? "L√•st" : "L√•s";
    btnL.onclick=()=>{ toggleLock(i); };
    const btnR = document.createElement("button"); btnR.className="btn red"; btnR.textContent="Radera";
    btnR.onclick=()=>{ removeSlot(i); };
    right.append(btnC, btnL, btnR);
    div.append(left, right);
    wrap.appendChild(div);
  });
}
function renderKPI(){
  const {stats} = loadApp();
  qs("#kpiStarted").textContent = stats.started;
  qs("#kpiCleared").textContent = stats.cleared;
  qs("#kpiAvg").textContent = stats.cleared ? Math.round((stats.mistakesTotal/stats.cleared)*10)/10 : 0;
  qs("#kpiBest").textContent = stats.best || 0;
}

/* ---- New / Load / Save ---- */
function labelDiff(d){ return {easy:"L√§tt",medium:"Medel",hard:"Sv√•r",master:"M√§stare"}[d]||d; }

function newGame(diff){
  const puzzle = pickRandom(PUZZLES[diff]);
  const arr = puzzle.split("").map(x=>+x);
  state.board = arr.slice();
  state.given = arr.map(v=>v!==0);
  state.note1 = Array.from({length:81},()=>new Set());
  state.note2 = Array.from({length:81},()=>new Set());
  state.undo=[]; state.redo=[];
  state.mistakes=0; state.difficulty=diff;
  state.r=0; state.c=0;

  const app = loadApp();
  const slotIdx = findWritableSlot(app);
  app.slots[slotIdx].data = serializeState();
  app.stats.started++;
  saveApp(app);
  state.current = slotIdx;
  renderGameUI();
  showGame();
  focusCell(0,0);
}

function loadSlot(i){
  const app = loadApp();
  const s = app.slots[i].data; if(!s) return;
  applySerialized(s);
  state.current = i;
  renderGameUI();
  showGame();
  focusCell(state.r, state.c);
}

function removeSlot(i){
  const app = loadApp();
  app.slots[i].data=null; app.slots[i].locked=false;
  saveApp(app); renderSlots();
}

function toggleLock(i){
  const app = loadApp();
  const lockedCount = app.slots.filter(s=>s.locked).length;
  if(!app.slots[i].locked && lockedCount>=2){ alert("Max tv√• l√•sta."); return; }
  app.slots[i].locked = !app.slots[i].locked;
  saveApp(app); renderSlots();
}

function findWritableSlot(app){
  // Prefer empty; else a non-locked oldest (slot order = simple priority)
  for(let i=0;i<3;i++) if(!app.slots[i].data && !app.slots[i].locked) return i;
  for(let i=0;i<3;i++) if(!app.slots[i].locked) return i;
  // If all locked, override slot 1
  return 0;
}

function autosave(){
  if(state.current==null) return;
  const app = loadApp();
  app.slots[state.current].data = serializeState();
  saveApp(app);
  updateHUD();
}

function serializeState(){
  return {
    board: state.board, given: state.given,
    n1: state.note1.map(s=>[...s]), n2: state.note2.map(s=>[...s]),
    undo: state.undo, redo: state.redo,
    r: state.r, c: state.c, mistakes: state.mistakes,
    difficulty: state.difficulty,
    empties: countEmpties(state.board)
  };
}
function applySerialized(s){
  state.board = s.board.slice();
  state.given = s.given.slice();
  state.note1 = s.n1.map(a=>new Set(a));
  state.note2 = s.n2.map(a=>new Set(a));
  state.undo = s.undo||[];
  state.redo = s.redo||[];
  state.r = s.r||0; state.c=s.c||0;
  state.mistakes = s.mistakes||0;
  state.difficulty = s.difficulty||"easy";
}

/* ---- Game UI ---- */
function renderGameUI(){
  // header
  qs("#verGame").textContent = APP_VERSION;
  qs("#diffInline").textContent = "‚Äì Sv√•righet: "+labelDiff(state.difficulty);
  // board
  const b = qs("#board"); clearChildren(b);
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const i = idx(r,c);
      const btn = document.createElement("button");
      btn.className="cell";
      btn.type="button";
      btn.setAttribute("role","gridcell");
      btn.setAttribute("aria-label",`Rad ${r+1}, Kolumn ${c+1}`);
      btn.dataset.r = r%3===2?2:r%3===1?1:0; // for thick lines
      btn.dataset.c = c%3===2?2:c%3===1?1:0;
      btn.tabIndex=0;
      if(state.given[i]) btn.classList.add("given");
      btn.addEventListener("click",()=>{ selectCell(r,c); });
      btn.addEventListener("keydown",cellKeydown);
      b.appendChild(btn);
    }
  }
  drawBoard();
  // pads
  buildPad(qs("#padMain"),"main");
  buildPad(qs("#padN1"),"n1");
  buildPad(qs("#padN2"),"n2");
  // header numbers
  updateHUD();
}

function buildPad(el,mode){
  clearChildren(el);
  for(let n=1;n<=9;n++){
    const k = document.createElement("button");
    k.type="button"; k.className="key"+(mode==="n1"?" red":mode==="n2"?" green":"");
    k.textContent = n;
    k.addEventListener("click",()=> onNum(n,mode));
    el.appendChild(k);
  }
}

function updateHUD(){
  qs("#verStart").textContent = APP_VERSION;
  qs("#mistakes").textContent = state.mistakes;
  qs("#empties").textContent = countEmpties(state.board);
}

/* ---- Board drawing & highlights ---- */
function drawBoard(){
  const cells = qsa(".cell");
  cells.forEach((cell,i)=>{
    cell.classList.remove("main","selected","rcb","same","error");
    const v = state.board[i];
    cell.textContent = v? v : "";
    if(!state.given[i] && v) cell.classList.add("main");

    // Notes
    const n1 = state.note1[i], n2 = state.note2[i];
    cell.querySelector(".note1")?.remove();
    cell.querySelector(".note2")?.remove();
    if(!v && n1.size){
      const box=document.createElement("div"); box.className="note1";
      for(let k=1;k<=9;k++){ const d=document.createElement("div"); d.className="n"; d.textContent=n1.has(k)?k:""; box.appendChild(d); }
      cell.appendChild(box);
    }
    if(!v && n2.size){
      const box=document.createElement("div"); box.className="note2";
      for(let k=1;k<=9;k++){ const d=document.createElement("div"); d.className="n"; d.textContent=n2.has(k)?k:""; box.appendChild(d); }
      cell.appendChild(box);
    }
  });
  applyHighlights();
  if(state.realtime) validateConflicts();
}

function applyHighlights(){
  const i = idx(state.r,state.c);
  const cells = qsa(".cell");
  cells.forEach(c=>c.classList.remove("selected","rcb","same"));
  const sameVal = state.board[i]||0;
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const j = idx(r,c);
      const el = cells[j];
      if(r===state.r || c===state.c || (Math.floor(r/3)===Math.floor(state.r/3) && Math.floor(c/3)===Math.floor(state.c/3))){
        el.classList.add("rcb");
      }
      if(j===i){ el.classList.add("selected"); }
      if(sameVal && state.board[j]===sameVal) el.classList.add("same");
    }
  }
}

/* ---- Selection & Keyboard ---- */
function selectCell(r,c){ state.r=r; state.c=c; drawBoard(); focusCell(r,c); }
function focusCell(r,c){
  const i = idx(r,c);
  const cell = qsa(".cell")[i];
  if(cell) cell.focus({preventScroll:false});
}
function cellKeydown(e){
  const {key} = e;
  if(key>="1" && key<="9"){ e.preventDefault(); onNum(+key,"main"); return; }
  if(key==="Backspace" || key==="Delete"){ e.preventDefault(); erase("main"); return; }
  if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(key)){
    e.preventDefault();
    let {r,c} = state;
    if(key==="ArrowUp") r = (r+8)%9;
    if(key==="ArrowDown") r = (r+1)%9;
    if(key==="ArrowLeft") c = (c+8)%9;
    if(key==="ArrowRight") c = (c+1)%9;
    selectCell(r,c);
  }
}

/* ---- Input handling ---- */
function onNum(n,mode){
  const i = idx(state.r,state.c);
  if(state.given[i]) return;

  if(mode==="main"){
    const prev = state.board[i];
    if(prev===n) return; // no-op
    pushUndo({t:"set",i,prev,val:n});
    state.board[i]=n;
    // candidate clearing in peers
    removeCandidatePeers(state.r,state.c,n);
    drawBoard();
    autosave();
  }else if(mode==="n1" || mode==="n2"){
    if(state.board[i]) return; // don't add notes in filled
    const set = mode==="n1" ? state.note1[i] : state.note2[i];
    const had = set.has(n);
    pushUndo({t:"note",mode,i,n,prev:had});
    if(had) set.delete(n); else set.add(n);
    drawBoard(); autosave();
  }
}

function erase(which){
  const i = idx(state.r,state.c);
  if(which==="main"){
    if(state.given[i]) return;
    const prev = state.board[i]; if(!prev) return;
    pushUndo({t:"set",i,prev,val:0});
    state.board[i]=0;
  }else if(which==="n1" || which==="n2"){
    const set = which==="n1"? state.note1[i] : state.note2[i];
    if(!set.size) return;
    pushUndo({t:"wipeNote",mode:which,i,prev:[...set]});
    set.clear();
  }
  drawBoard(); autosave();
}

function removeCandidatePeers(r,c,n){
  for(let k=0;k<9;k++){
    const i1 = idx(r,k); state.note1[i1]?.delete(n); state.note2[i1]?.delete(n);
    const i2 = idx(k,c); state.note1[i2]?.delete(n); state.note2[i2]?.delete(n);
  }
  const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
  for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++){
    const i = idx(br+rr, bc+cc);
    state.note1[i]?.delete(n); state.note2[i]?.delete(n);
  }
}

/* ---- Undo / Redo ---- */
function pushUndo(act){ state.undo.push(act); state.redo.length=0; }
function doUndo(){
  const act = state.undo.pop(); if(!act) return;
  state.redo.push(act);
  if(act.t==="set"){ state.board[act.i]=act.prev; }
  if(act.t==="note"){ const set = act.mode==="n1"? state.note1[act.i] : state.note2[act.i]; if(act.prev) set.add(act.n); else set.delete(act.n); }
  if(act.t==="wipeNote"){ const set = act.mode==="n1"? state.note1[act.i] : state.note2[act.i]; set.clear(); act.prev.forEach(v=>set.add(v)); }
  drawBoard(); autosave();
}
function doRedo(){
  const act = state.redo.pop(); if(!act) return;
  state.undo.push(act);
  if(act.t==="set"){ state.board[act.i]=act.val; }
  if(act.t==="note"){ const set = act.mode==="n1"? state.note1[act.i] : state.note2[act.i]; if(act.prev) set.delete(act.n); else set.add(act.n); }
  if(act.t==="wipeNote"){ const set = act.mode==="n1"? state.note1[act.i] : state.note2[act.i]; set.clear(); }
  drawBoard(); autosave();
}

/* ---- Validation & Hint ---- */
function validateConflicts(){
  const cells = qsa(".cell");
  cells.forEach(c=>c.classList.remove("error"));
  // mark duplicates in row / col / box
  for(let r=0;r<9;r++){
    markDupGroup([...Array(9)].map((_,c)=>idx(r,c)));
  }
  for(let c=0;c<9;c++){
    markDupGroup([...Array(9)].map((_,r)=>idx(r,c)));
  }
  for(let br=0;br<3;br++) for(let bc=0;bc<3;bc++){
    const arr=[]; for(let r=0;r<3;r++) for(let c=0;c<3;c++) arr.push(idx(br*3+r,bc*3+c));
    markDupGroup(arr);
  }
  function markDupGroup(indexes){
    const seen = {};
    indexes.forEach(i=>{
      const v=state.board[i];
      if(!v) return;
      if(!seen[v]) seen[v]=[];
      seen[v].push(i);
    });
    Object.values(seen).forEach(list=>{
      if(list.length>1){
        list.forEach(i=> qsa(".cell")[i].classList.add("error"));
      }
    });
  }
}
function onCheck(){
  const before = document.querySelectorAll(".cell.error").length;
  validateConflicts();
  const after = document.querySelectorAll(".cell.error").length;
  if(after>0) state.mistakes++;
  drawBoard(); autosave();
  checkSolved();
}

function checkSolved(){
  if(countEmpties(state.board)!==0) return false;
  // simple legality check
  const ok = isLegal(state.board);
  if(ok){
    const app = loadApp();
    app.stats.cleared++;
    app.stats.mistakesTotal += state.mistakes;
    app.stats.best = app.stats.best? Math.min(app.stats.best, state.mistakes) : state.mistakes;
    saveApp(app);
    alert("Grattis! Du l√∂ste sudokut üéâ");
    showStart();
  }
  return ok;
}

function isLegal(b){
  // rows
  for(let r=0;r<9;r++){
    const set=new Set();
    for(let c=0;c<9;c++){ const v=b[idx(r,c)]; if(v<1||v>9||set.has(v)) return false; set.add(v); }
  }
  // cols
  for(let c=0;c<9;c++){
    const set=new Set();
    for(let r=0;r<9;r++){ const v=b[idx(r,c)]; if(v<1||v>9||set.has(v)) return false; set.add(v); }
  }
  // boxes
  for(let br=0;br<3;br++) for(let bc=0;bc<3;bc++){
    const set=new Set();
    for(let r=0;r<3;r++) for(let c=0;c<3;c++){
      const v=b[idx(br*3+r, bc*3+c)]; if(v<1||v>9||set.has(v)) return false; set.add(v);
    }
  }
  return true;
}

function candidatesAt(r,c){
  if(state.board[idx(r,c)]) return [];
  const taken=new Set();
  for(let k=0;k<9;k++){ taken.add(state.board[idx(r,k)]); taken.add(state.board[idx(k,c)]); }
  const br=Math.floor(r/3)*3, bc=Math.floor(c/3)*3;
  for(let rr=0;rr<3;rr++) for(let cc=0;cc<3;cc++) taken.add(state.board[idx(br+rr,bc+cc)]);
  const res=[]; for(let n=1;n<=9;n++) if(!taken.has(n)) res.push(n);
  return res;
}
function onHint(){
  // Find any naked single
  for(let r=0;r<9;r++){
    for(let c=0;c<9;c++){
      const i=idx(r,c); if(state.board[i]) continue;
      const cands = candidatesAt(r,c);
      if(cands.length===1){
        selectCell(r,c);
        onNum(cands[0],"main");
        return;
      }
    }
  }
  alert("Inga enkla tips just nu (naked single).");
}

/* ---- Utils ---- */
function countEmpties(b){ let n=0; for(const v of b) if(!v) n++; return n; }
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function rgbToHex(rgb){
  if(!rgb) return "#000000";
  if(rgb[0]==="#") return rgb;
  const m = rgb.match(/\d+/g)||[0,0,0];
  return "#"+m.slice(0,3).map(x=>(+x).toString(16).padStart(2,"0")).join("");
}

/* ---- Event Wiring ---- */
function wire(){
  // Start screen
  qsa('[data-new]').forEach(b=> b.addEventListener('click',()=> newGame(b.dataset.new)));
  // Game header
  qs("#btnHome").addEventListener("click",showStart);
  qs("#btnCheck").addEventListener("click",onCheck);
  qs("#btnSettings").addEventListener("click",()=> openSheet(true));
  // Actions
  qs("#undo").addEventListener("click",doUndo);
  qs("#redo").addEventListener("click",doRedo);
  qs("#eraseMain").addEventListener("click",()=>erase("main"));
  qs("#eraseN1").addEventListener("click",()=>erase("n1"));
  qs("#eraseN2").addEventListener("click",()=>erase("n2"));
  qs("#hint").addEventListener("click",onHint);

  // Settings
  qs("#closeSheet").addEventListener("click",()=> openSheet(false));
  qs("#selTheme").addEventListener("change",e=> applyTheme(e.target.value));
  qs("#chkRealtime").addEventListener("change",e=> {state.realtime=e.target.checked; drawBoard(); autosave();});

  // Color inputs
  qs("#colGiven").addEventListener("input",e=> setVar("--given", e.target.value));
  qs("#colMain").addEventListener("input",e=> setVar("--main", e.target.value));
  qs("#colN1").addEventListener("input",e=> setVar("--note1", e.target.value));
  qs("#colN2").addEventListener("input",e=> setVar("--note2", e.target.value));
  qs("#colHLrcb").addEventListener("input",e=> setVar("--hl-rcb", e.target.value));
  qs("#colHLsame").addEventListener("input",e=> setVar("--hl-same", e.target.value));

  // Grid swatches
  const sw = qs("#swGrid");
  const greys = ["#000000","#1f2937","#374151","#6b7280","#9ca3af","#cbd5e1","#e5e7eb","#ffffff"];
  greys.forEach(col=>{
    const s=document.createElement("button");
    s.className="swatch"; s.style.background=col; s.title=col;
    s.addEventListener("click",()=> setVar("--grid", col));
    sw.appendChild(s);
  });

  // Restore theme vars
  loadTheme();

  // Restore realtime + version labels
  qs("#verStart").textContent = APP_VERSION;
  qs("#chkRealtime").checked = state.realtime;

  // Build pads once
  buildPad(qs("#padMain"),"main");
  buildPad(qs("#padN1"),"n1");
  buildPad(qs("#padN2"),"n2");

  showStart();
}

/* ---- Sheet open/close ---- */
function openSheet(open){
  const s=qs("#sheet");
  if(open){ s.classList.add("open"); s.setAttribute("aria-hidden","false"); }
  else{ s.classList.remove("open"); s.setAttribute("aria-hidden","true"); }
}

/* ---- Init ---- */
window.addEventListener("load", wire);

/* ---- Service Worker ---- */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
